'use strict';(function(){Alfresco.logger.debug("flash-upload-plus.js");SoftwareLoop.FlashUpload=function(a){SoftwareLoop.FlashUpload.superclass.constructor.call(this,"null");Alfresco.util.ComponentManager.unregister(this);this.id="undefined"==typeof a||null===a?Alfresco.util.generateDomId():a;this.name="SoftwareLoop.FlashUpload";Alfresco.util.ComponentManager.register(this);return this};YAHOO.lang.extend(SoftwareLoop.FlashUpload,Alfresco.FlashUpload,YAHOO.lang.merge(SoftwareLoop.UploaderPlusMixin,
{savedDialogTitle:null,records:null,currentRecordIndex:-1,show:function(a){Alfresco.logger.debug("show",arguments);SoftwareLoop.FlashUpload.superclass.show.call(this,a);this.shouldUseSameMetadataSet||this.cleanupOldFormForNextUpload();this.loadTypes(this.populateSelect,this);Alfresco.logger.debug("END show")},_createEmptyDataTable:function(){Alfresco.logger.debug("_createEmptyDataTable",arguments);SoftwareLoop.FlashUpload.superclass._createEmptyDataTable.apply(this,arguments);this.widgets.dataTable.subscribe("rowsAddEvent",
this.onRowsAddEvent,this,!0);Alfresco.logger.debug("END _createEmptyDataTable")},onRowsAddEvent:function(a){Alfresco.logger.debug("onRowsAddEvent",arguments);this.showConfig.mode===this.MODE_SINGLE_UPDATE?Alfresco.logger.debug("Single update"):null==this.types?Alfresco.logger.debug("Types is null"):(this.savedDialogTitle=YAHOO.util.Dom.get(this.id+"-title-span").innerText,this.records=a.records,this.currentRecordIndex=0,this.showMetadataDialog(),Alfresco.logger.debug("END onRowsAddEvent"))},showMetadataDialog:function(){Alfresco.logger.debug("showMetadataDialog",
arguments);if(this.currentRecordIndex==this.records.length)return Alfresco.logger.debug("At the end of the records array"),this.showMainDialog();var a=this.records[this.currentRecordIndex].getData();YAHOO.util.Dom.get(this.id+"-title-span").innerText=Alfresco.util.encodeHTML(a.name);YAHOO.util.Dom.addClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.removeClass(this.id+"-metadata-dialog","hidden");this.contentTypeSelectNode.selectedIndex=0;SoftwareLoop.fireEvent(this.contentTypeSelectNode,
"change");Alfresco.logger.debug("END showMetadataDialog")},showMainDialog:function(){Alfresco.logger.debug("showMainDialog",arguments);null!=this.savedDialogTitle&&(Alfresco.logger.debug("Restore saved dialog title"),YAHOO.util.Dom.get(this.id+"-title-span").innerText=this.savedDialogTitle,this.savedDialogTitle=null);this.records=null;this.currentRecordIndex=-1;YAHOO.util.Dom.removeClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.addClass(this.id+"-metadata-dialog","hidden");this.centerPanel();
Alfresco.logger.debug("END showMainDialog")},_resetGUI:function(){Alfresco.logger.debug("_resetGUI",arguments);this.showMainDialog();SoftwareLoop.FlashUpload.superclass._resetGUI.apply(this,arguments);Alfresco.logger.debug("END _resetGUI")},onMetadataCancel:function(){Alfresco.logger.debug("onMetadataCancel",arguments);this.records.reverse();for(var a=0;a<this.records.length;a++){var d=this.records[a];Alfresco.logger.debug("Canceling record:",d);var g=d.getData().id;d=d.getId();this._onFileButtonClickHandler(g,
d)}this.showMainDialog();Alfresco.logger.debug("END onMetadataCancel")},_uploadFromQueue:function(a){Alfresco.logger.debug("_uploadFromQueue",arguments);var d=null===this.showConfig.uploadURL?Alfresco.constants.PROXY_URI+"uploader-plus/upload":Alfresco.constants.PROXY_URI+this.showConfig.uploadURL;d+=";jsessionid="+YAHOO.util.Cookie.get("JSESSIONID")+"?lang="+Alfresco.constants.JS_LOCALE;Alfresco.util.CSRFPolicy.isFilterEnabled()&&(d+="&"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken()));
for(var g=0,k=this.widgets.dataTable.getRecordSet().getLength(),f,b,c,h=0;h<k&&g<a;h++)if(f=this.widgets.dataTable.getRecordSet().getRecord(h),f=f.getData("id"),b=this.fileStore[f],b.state===this.STATE_BROWSING){b.state=this.STATE_UPLOADING;c={username:this.showConfig.username};null!==this.showConfig.siteId?(c.siteId=this.showConfig.siteId,c.containerId=this.showConfig.containerId):null!==this.showConfig.destination&&(c.destination=this.showConfig.destination);if(this.showConfig.mode===this.MODE_SINGLE_UPDATE)c.updateNodeRef=
this.showConfig.updateNodeRef,c.majorVersion=!this.minorVersion.checked,c.description=this.description.value;else{null!==this.showConfig.uploadDirectory&&(c.uploadDirectory=this.showConfig.uploadDirectory);b.contentType&&("select"==b.contentType.tagName.toLowerCase()?c.contentType=b.contentType.options[b.contentType.selectedIndex].value:c.contentType=b.contentType.value);c.overwrite=this.showConfig.overwrite;this.showConfig.thumbnails&&(c.thumbnails=this.showConfig.thumbnails);Alfresco.logger.debug("fileInfo",
b);if(b.propertyData){Alfresco.logger.debug("Processing propertyData");for(var e in b.propertyData)Alfresco.logger.debug("Current:",e),b.propertyData.hasOwnProperty(e)&&("prop_mimetype"!=e||"prop_mimetype"==e&&YAHOO.lang.isString(b.propertyData[e])&&0<b.propertyData[e].length)&&(Alfresco.logger.debug("Adding attribute",e),c[e]=b.propertyData[e])}Alfresco.logger.debug("Attributes:",c)}this.uploader.upload(f,d,"POST",c,"filedata");g++}}}))})();
