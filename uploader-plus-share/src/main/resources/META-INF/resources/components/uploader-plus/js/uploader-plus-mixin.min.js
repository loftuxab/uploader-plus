'use strict';(function(){Alfresco.logger.debug("uploader-plus-mixin.js");SoftwareLoop.UploaderPlusMixin={allowedContentTypesDestinationTemplate:Alfresco.constants.PROXY_URI+"uploader-plus/allowed-content-types?destination={destination}",allowedContentTypesSiteTemplate:Alfresco.constants.PROXY_URI+"uploader-plus/allowed-content-types?siteid={siteId}&containerid={containerId}&path={uploadDirectory}",allowedContentTypesBlankUrl:Alfresco.constants.PROXY_URI+"uploader-plus/allowed-content-types",types:null,
typesLoaded:!1,shouldUseSameMetadataSet:!1,loadTypes:function(a,b){Alfresco.logger.debug("loadTypes",arguments);if(this.showConfig.destination){Alfresco.logger.debug("Repository folder",this.showConfig.destination);var d=YAHOO.lang.substitute(this.allowedContentTypesDestinationTemplate,{destination:encodeURIComponent(this.showConfig.destination)})}else this.showConfig.siteId?(Alfresco.logger.debug("Site",this.showConfig.siteId),d=YAHOO.lang.substitute(this.allowedContentTypesSiteTemplate,{siteId:encodeURIComponent(this.showConfig.siteId),
containerId:encodeURIComponent(this.showConfig.containerId),uploadDirectory:encodeURIComponent(this.showConfig.uploadDirectory)})):(Alfresco.logger.debug("Outside repository or site"),d=this.allowedContentTypesBlankUrl);Alfresco.util.Ajax.jsonGet({url:d,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(c){Alfresco.logger.debug("loadTypes successCallback",arguments);this.types=c.json.types;this.typesLoaded=!0;a&&(void 0!==b?a.call(b):a.call(this))},scope:this},failureCallback:{fn:function(c){Alfresco.logger.debug("loadTypes failureCallback",
arguments)},scope:this}});Alfresco.logger.debug("END loadTypes")},populateSelect:function(){Alfresco.logger.debug("populateSelect",arguments);if(null==this.types)Alfresco.logger.debug("Types == null");else{this.contentTypeSelectNode=YAHOO.util.Dom.get(this.id+"-content-type-select");this.contentTypeSelectNode.innerHTML="";for(var a=0;a<this.types.length;a++){Alfresco.logger.debug("Type index",a);var b=this.types[a];b=new Option(this.msg("type."+b.replace(":","_")),b,0===a);this.contentTypeSelectNode.add(b)}YAHOO.util.Event.removeListener(this.contentTypeSelectNode,
"change");YAHOO.util.Event.addListener(this.contentTypeSelectNode,"change",this.onContentTypeChange,this,!0);Alfresco.logger.debug("END populateSelect")}},onContentTypeChange:function(){Alfresco.logger.debug("onContentTypeChange",arguments);var a=this.id+"-metadata-form";a=YAHOO.lang.substitute("{serviceContext}components/form?itemKind=type&itemId={itemId}&mode=create&submitType=json&formId={formId}&showCancelButton=true&htmlid={htmlid}&destination={destination}&siteId={siteId}&containerId={containerId}&uploadDirectory={uploadDirectory}",
{serviceContext:Alfresco.constants.URL_SERVICECONTEXT,itemId:this.contentTypeSelectNode.value,formId:"upload-folder",destination:encodeURIComponent(this.showConfig.destination||""),siteId:encodeURIComponent(this.showConfig.siteId||""),containerId:encodeURIComponent(this.showConfig.containerId||""),uploadDirectory:encodeURIComponent(this.showConfig.uploadDirectory||""),htmlid:a});Alfresco.util.Ajax.request({url:a,responseContentType:"html",execScripts:!0,successCallback:{fn:this.onMetadataFormReceived,
scope:this},failureCallback:{fn:function(b){Alfresco.logger.debug("onContentTypeChange failureCallback",arguments)},scope:this}});Alfresco.logger.debug("END onContentTypeChange")},onMetadataFormReceived:function(a){Alfresco.logger.debug("onMetadataFormReceived",arguments);YAHOO.util.Dom.get(this.id+"-metadata-form").innerHTML=a.serverResponse.responseText;var b=this.records[this.currentRecordIndex].getData(),d=YAHOO.util.Dom.get(this.id+"-metadata-form_prop_cm_name");d&&(Alfresco.logger.debug("metadata-form_prop_cm_name found"),
d.value=b.name,d.readOnly=!1);this.formUi=Alfresco.util.ComponentManager.find({id:this.id+"-metadata-form-form",name:"Alfresco.FormUI"})[0];var c=this.formUi.onReady;this.formUi.onReady=SoftwareLoop.hitch(this,function(){Alfresco.logger.debug("onReady",arguments);c.apply(this.formUi,arguments);this.formUiFixButtons()});this.useSameMetadataSetCBNode=YAHOO.util.Dom.get(this.id+"-same-metadata-set-cb");YAHOO.util.Event.removeListener(this.useSameMetadataSetCBNode,"change");this.hideUseSameMetadataSet();
0===this.currentRecordIndex&&1<this.records.length&&this.showUseSameMetadataSet();this.centerPanel();Alfresco.logger.debug("END onMetadataFormReceived")},hideUseSameMetadataSet:function(){this.useSameMetadataSetCBNode.checked=!1;this.shouldUseSameMetadataSet=this.useSameMetadataSetCBNode.checked;YAHOO.util.Dom.setStyle(this.id+"-same-metadata-set","display","none");YAHOO.util.Event.removeListener(this.useSameMetadataSetCBNode,"change")},showUseSameMetadataSet:function(){this.useSameMetadataSetCBNode.checked=
!1;this.shouldUseSameMetadataSet=this.useSameMetadataSetCBNode.checked;SoftwareLoop.fireEvent(this.useSameMetadataSetCBNode,"change");YAHOO.util.Dom.setStyle(this.id+"-same-metadata-set","display","inline");YAHOO.util.Event.addListener(this.useSameMetadataSetCBNode,"change",this.onUseSameMetadataSetCBChange,this,!0)},onUseSameMetadataSetCBChange:function(){this.shouldUseSameMetadataSet=this.useSameMetadataSetCBNode.checked;var a=this.formUi.buttons.submit,b=YAHOO.util.Dom.get(this.id+"-metadata-form_prop_cm_name");
this.shouldUseSameMetadataSet?(a.set("label",this.msg("label.ok")),b&&YAHOO.util.Dom.setStyle(b.parentNode,"display","none")):this.currentRecordIndex!==this.records.length-1&&(a.set("label",this.msg("uploader.plus.next")),b&&YAHOO.util.Dom.setStyle(b.parentNode,"display","inline-block"))},formUiFixButtons:function(){Alfresco.logger.debug("formUiFixButtons",arguments);var a=this.formUi.buttons.submit;a.removeListener("click");a.addListener("click",this.onMetadataSubmit,this,this);this.currentRecordIndex===
this.records.length-1?(Alfresco.logger.debug("Last document"),a.set("label",this.msg("label.ok"))):(Alfresco.logger.debug("More documents"),a.set("label",this.msg("uploader.plus.next")));a=this.formUi.buttons.cancel;a.removeListener("click");a.addListener("click",this.onMetadataCancel,this,this);Alfresco.logger.debug("END formUiFixButtons")},onMetadataSubmit:function(){Alfresco.logger.debug("onMetadataSubmit",arguments);this.formUi.formsRuntime._setAllFieldsAsVisited();if(this.formUi.formsRuntime._runValidations(null,
null,Alfresco.forms.Form.NOTIFICATION_LEVEL_CONTAINER)){Alfresco.logger.debug("Form validated");do{this.processMetadata();var a=this.records[this.currentRecordIndex].getData().id;a=this.fileStore[a];this.shouldUseSameMetadataSet&&a.propertyData.prop_cm_name&&delete a.propertyData.prop_cm_name}while(++this.currentRecordIndex<this.records.length&&this.shouldUseSameMetadataSet);this.cleanupOldFormForNextUpload();this.showMetadataDialog()}else Alfresco.logger.debug("Form with errors");Alfresco.logger.debug("END onMetadataSubmit")},
processMetadata:function(){Alfresco.logger.debug("processMetadata",arguments);var a=this.contentTypeSelectNode.value,b=this.records[this.currentRecordIndex],d=b.getData(),c=YAHOO.util.Dom.get(this.id+"-metadata-form_prop_cm_name");if(c&&!this.shouldUseSameMetadataSet){var e=this.fileStore[d.id];d.name=c.value;e.uploadData.filename=c.value}c=this.getDataTable();b=c.getFirstTdEl(b);(e=Dom.getElementsByClassName("fileupload-contentType-input","input",b))&&1===e.length?(Alfresco.logger.debug("fileupload-contentType-input found"),
e[0].value=a):Alfresco.logger.debug("fileupload-contentType-input not found");b=c.getNextTdEl(b);(c=Dom.getElementsByClassName("fileupload-progressInfo-span","span",b))&&1===c.length?(Alfresco.logger.debug("fileupload-progressInfo-span found"),YAHOO.util.Dom.addClass(c[0],"uploader-plus"),$(c[0]).html(d.name),$(c[0]).parent().prop("title",d.name)):Alfresco.logger.debug("fileupload-progressInfo-span not found");(c=Dom.getElementsByClassName("fileupload-filesize-span","span",b))&&1===c.length?(Alfresco.logger.debug("fileupload-filesize-span found"),
YAHOO.util.Dom.addClass(c[0],"uploader-plus")):Alfresco.logger.debug("fileupload-filesize-span not found");(b=Dom.getElementsByClassName("fileupload-typeInfo-span","span",b))&&1===b.length?(Alfresco.logger.debug("fileupload-typeInfo-span found"),YAHOO.util.Dom.removeClass(b[0],"hidden"),b[0].innerHTML=Alfresco.util.encodeHTML(this.msg("content.type")+": "+a)):Alfresco.logger.debug("fileupload-typeInfo-span not found");b=this.formUi.formsRuntime;c=Dom.get(b.formId);b=b._buildAjaxForSubmit(c);b.contentType=
a;this.fileStore[d.id].propertyData=b;Alfresco.logger.debug("END processMetadata",b)},getDataTable:function(){Alfresco.logger.debug("getDataTable",arguments);if(this.dataTable)return Alfresco.logger.debug("this.dataTable"),this.dataTable;Alfresco.logger.debug("this.widgets.dataTable");return this.widgets.dataTable},getPanel:function(){Alfresco.logger.debug("getPanel",arguments);if(this.widgets.panel)return Alfresco.logger.debug("4.2.x-style panel"),this.widgets.panel;Alfresco.logger.debug("5.0.x-style panel");
return this.panel},centerPanel:function(){Alfresco.logger.debug("centerPanel",arguments);this.getPanel().center();Alfresco.logger.debug("END centerPanel")},cleanupOldFormForNextUpload:function(){for(var a=YAHOO.util.Dom.get(this.id+"-metadata-form");a.hasChildNodes();)a.removeChild(a.lastChild)}}})();
