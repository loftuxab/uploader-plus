'use strict';(function(){Alfresco.logger.debug("dnd-upload-plus.js");SoftwareLoop.DNDUpload=function(a){SoftwareLoop.DNDUpload.superclass.constructor.call(this,"null");Alfresco.util.ComponentManager.unregister(this);this.id="undefined"==typeof a||null===a?Alfresco.util.generateDomId():a;this.name="SoftwareLoop.DNDUpload";Alfresco.util.ComponentManager.register(this);return this};YAHOO.lang.extend(SoftwareLoop.DNDUpload,Alfresco.DNDUpload,YAHOO.lang.merge(SoftwareLoop.UploaderPlusMixin,{spawnUploadsBooked:!1,
savedDialogTitle:null,records:null,currentRecordIndex:-1,show:function(a){Alfresco.logger.debug("show",arguments);SoftwareLoop.DNDUpload.superclass.show.call(this,a);this.loadTypes(function(){Alfresco.logger.debug("loadTypes callback");this.populateSelect();this.spawnUploadsBooked&&(Alfresco.logger.debug("this.spawnUploadsBooked is true"),this.spawnUploadsBooked=!1,this._spawnUploads())},this);Alfresco.logger.debug("END show")},_spawnUploads:function(){Alfresco.logger.debug("_spawnUploads",arguments);
if(this.typesLoaded){this.shouldUseSameMetadataSet||this.cleanupOldFormForNextUpload();if(this.showConfig.mode===this.MODE_SINGLE_UPDATE)return Alfresco.logger.debug("Single update"),SoftwareLoop.DNDUpload.superclass._spawnUploads.call(this);if(null==this.types)return Alfresco.logger.debug("Types is null"),SoftwareLoop.DNDUpload.superclass._spawnUploads.call(this);this.savedDialogTitle=YAHOO.util.Dom.get(this.id+"-title-span").innerText;this.records=this.dataTable.getRecordSet().getRecords();Alfresco.logger.debug("records",
this.records);this.currentRecordIndex=0;this.showMetadataDialog();Alfresco.logger.debug("END _spawnUploads")}else Alfresco.logger.debug("Types not loaded yet. Postponing"),this.spawnUploadsBooked=!0},showMetadataDialog:function(){Alfresco.logger.debug("showMetadataDialog",arguments);if(this.currentRecordIndex==this.records.length)return Alfresco.logger.debug("At the end of the records array"),this.showMainDialog(),SoftwareLoop.DNDUpload.superclass._spawnUploads.apply(this);var a=this.records[this.currentRecordIndex].getData();
if(this.fileStore[a.id].state!==this.STATE_ADDED)return Alfresco.logger.debug("State != STATE_ADDED"),SoftwareLoop.DNDUpload.superclass._spawnUploads.apply(this);YAHOO.util.Dom.get(this.id+"-title-span").innerText=Alfresco.util.encodeHTML(a.name);YAHOO.util.Dom.addClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.removeClass(this.id+"-metadata-dialog","hidden");this.contentTypeSelectNode.selectedIndex=0;SoftwareLoop.fireEvent(this.contentTypeSelectNode,"change");Alfresco.logger.debug("END showMetadataDialog")},
showMainDialog:function(){Alfresco.logger.debug("showMainDialog",arguments);null!=this.savedDialogTitle&&(Alfresco.logger.debug("Restore saved dialog title"),YAHOO.util.Dom.get(this.id+"-title-span").innerText=this.savedDialogTitle,this.savedDialogTitle=null);this.records=null;this.currentRecordIndex=-1;YAHOO.util.Dom.removeClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.addClass(this.id+"-metadata-dialog","hidden");this.centerPanel();Alfresco.logger.debug("END showMainDialog")},_resetGUI:function(){Alfresco.logger.debug("_resetGUI",
arguments);this.showMainDialog();SoftwareLoop.DNDUpload.superclass._resetGUI.apply(this,arguments);Alfresco.logger.debug("END _resetGUI")},onMetadataCancel:function(a){Alfresco.logger.debug("onMetadataCancel",arguments);this.showMainDialog();this.onCancelOkButtonClick(a);Alfresco.logger.debug("END onMetadataCancel")},_startUpload:function(a){Alfresco.logger.debug("_startUpload",arguments);a.state=this.STATE_UPLOADING;var e=null===this.showConfig.uploadURL?Alfresco.constants.PROXY_URI+"uploader-plus/upload":
Alfresco.constants.PROXY_URI+this.showConfig.uploadURL;Alfresco.util.CSRFPolicy.isFilterEnabled()&&(e+="?"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken()));if(this.uploadMethod===this.FORMDATA_UPLOAD){Alfresco.logger.debug("Using FormData for file upload");var b=new FormData;b.append("filedata",a.uploadData.filedata);b.append("filename",a.uploadData.filename);b.append("destination",a.uploadData.destination);b.append("uploaddirectory",a.uploadData.uploaddirectory);
b.append("createdirectory",a.uploadData.createdirectory?"true":"false");b.append("majorVersion",a.uploadData.majorVersion?"true":"false");b.append("username",a.uploadData.username);b.append("overwrite",a.uploadData.overwrite);b.append("thumbnails",a.uploadData.thumbnails);b.append("updatenameandmimetype",a.uploadData.updateNameAndMimetype);a.uploadData.updateNodeRef?b.append("updateNodeRef",a.uploadData.updateNodeRef):(b.append("siteId",a.uploadData.siteId),b.append("containerId",a.uploadData.containerId));
a.uploadData.description&&b.append("description",a.uploadData.description);Alfresco.logger.debug("fileInfo",a);if(a.propertyData){a.propertyData.contentType&&(Alfresco.logger.debug("Appending content type",a.propertyData.contentType),b.append("contentType",a.propertyData.contentType));Alfresco.logger.debug("Processing propertyData");for(var d in a.propertyData)Alfresco.logger.debug("Current:",d),a.propertyData.hasOwnProperty(d)&&("prop_mimetype"!=d||"prop_mimetype"==d&&YAHOO.lang.isString(a.propertyData[d])&&
0<a.propertyData[d].length)&&(Alfresco.logger.debug("Appending",d),b.append(d,a.propertyData[d]))}else this.contentTypeSelectNode&&this.contentTypeSelectNode.value&&(Alfresco.logger.debug("Appending content type",this.contentTypeSelectNode.value),b.append("contentType",this.contentTypeSelectNode.value));Alfresco.logger.debug("formData:",b);a.request.open("POST",e,!0);a.request.send(b);a.request.onreadystatechange=function(){if(401===this.status){var f=this.getResponseHeader.Location;f?window.location.href=
window.location.protocol+"//"+window.location.host+f:window.location.reload(!0)}}}else if(this.uploadMethod===this.INMEMORY_UPLOAD){Alfresco.logger.debug("Using custom multipart upload");b="----AlfrescoCustomMultipartBoundary"+(new Date).getTime();var c="--"+b+('\r\nContent-Disposition: form-data; name="filedata"; filename="'+unescape(encodeURIComponent(a.uploadData.filename))+'"');c=c+"\r\nContent-Type: image/png\r\n\r\n"+(a.uploadData.filedata.getAsBinary()+"\r\n--"+b);c=c+'\r\nContent-Disposition: form-data; name="filename"\r\n\r\n'+
(unescape(encodeURIComponent(a.uploadData.filename))+"\r\n--"+b);c+='\r\nContent-Disposition: form-data; name="destination"';c=null!==a.uploadData.destination?c+("\r\n\r\n"+unescape(encodeURIComponent(a.uploadData.destination))+"\r\n--"+b):c+("\r\n\r\n\r\n--"+b);c=c+'\r\nContent-Disposition: form-data; name="siteId"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.siteId))+"\r\n--"+b);c=c+'\r\nContent-Disposition: form-data; name="containerId"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.containerId))+
"\r\n--"+b);c=c+'\r\nContent-Disposition: form-data; name="uploaddirectory"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.uploaddirectory))+"\r\n--"+b+"--");c=c+'\r\nContent-Disposition: form-data; name="majorVersion"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.majorVersion))+"\r\n--"+b+"--");a.uploadData.updateNodeRef&&(c=c+'\r\nContent-Disposition: form-data; name="updateNodeRef"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.updateNodeRef))+"\r\n--"+b+"--"));a.uploadData.description&&
(c=c+'\r\nContent-Disposition: form-data; name="description"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.description))+"\r\n--"+b+"--"));a.uploadData.username&&(c=c+'\r\nContent-Disposition: form-data; name="username"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.username))+"\r\n--"+b+"--"));a.uploadData.overwrite&&(c=c+'\r\nContent-Disposition: form-data; name="overwrite"\r\n\r\n'+(unescape(encodeURIComponent(a.uploadData.overwrite))+"\r\n--"+b+"--"));a.uploadData.thumbnails&&(c=c+'\r\nContent-Disposition: form-data; name="thumbnails"\r\n\r\n'+
(unescape(encodeURIComponent(a.uploadData.thumbnails))+"\r\n--"+b+"--"));this.contentTypeSelectNode&&this.contentTypeSelectNode.value&&(c=c+'\r\nContent-Disposition: form-data; name="contentType"\r\n\r\n'+(unescape(encodeURIComponent(this.contentTypeSelectNode.value))+"\r\n--"+b+"--"));if(a.propertyData)for(d in a.propertyData)a.propertyData.hasOwnProperty(d)&&("prop_mimetype"!=d||"prop_mimetype"==d&&YAHOO.lang.isString(a.propertyData[d])&&0<a.propertyData[d].length)&&(c+='\r\nContent-Disposition: form-data; name="'+
d+'"',c+="\r\n\r\n"+unescape(encodeURIComponent(a.propertyData[d]))+"\r\n--"+b+"--");a.request.open("POST",e,!0);a.request.setRequestHeader("Content-Type","multipart/form-data; boundary="+b);a.request.sendAsBinary(c)}}}))})();
