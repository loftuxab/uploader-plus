'use strict';(function(){Alfresco.logger.debug("html-upload-plus.js");SoftwareLoop.HtmlUpload=function(a){SoftwareLoop.HtmlUpload.superclass.constructor.call(this,"null");Alfresco.util.ComponentManager.unregister(this);this.id="undefined"==typeof a||null===a?Alfresco.util.generateDomId():a;this.name="SoftwareLoop.HtmlUpload";Alfresco.util.ComponentManager.register(this);return this};YAHOO.lang.extend(SoftwareLoop.HtmlUpload,Alfresco.HtmlUpload,YAHOO.lang.merge(SoftwareLoop.UploaderPlusMixin,{records:null,
currentRecordIndex:-1,show:function(a){Alfresco.logger.debug("show",arguments);this.showMainDialog();SoftwareLoop.HtmlUpload.superclass.show.call(this,a);this.shouldUseSameMetadataSet||this.cleanupOldFormForNextUpload();this.loadTypes(function(){Alfresco.logger.debug("loadTypes callback");this.populateSelect();null!=this.types&&(Alfresco.logger.debug("this.types is not null"),this.fixButtons())},this);Alfresco.logger.debug("END show")},fixButtons:function(){Alfresco.logger.debug("fixButtons",arguments);
this.widgets.uploadButton.set("label",this.msg("uploader.plus.next"));this.widgets.uploadButton.removeListener("click");this.widgets.uploadButton.on("click",function(a){Alfresco.logger.debug("uploadButton callback",a);this.widgets.form._setAllFieldsAsVisited();this.widgets.form.validate()&&(Alfresco.logger.debug("Form validation passed"),this.showMetadataDialog())},this,this);Alfresco.logger.debug("END fixButtons")},showMetadataDialog:function(){Alfresco.logger.debug("showMetadataDialog",arguments);
YAHOO.util.Dom.addClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.removeClass(this.id+"-metadata-dialog","hidden");if(this.widgets.filedata.files){Alfresco.logger.debug("Filedata files available");var a=this.widgets.filedata.files[0].name}else{Alfresco.logger.debug("IE-style full path");var c=this.widgets.filedata.value;a=c.substring(c.lastIndexOf("\\")+1)}this.currentRecordIndex=0;this.records=[];this.records.push({getData:function(){Alfresco.logger.debug("getData callback");return{name:a}}});
SoftwareLoop.fireEvent(this.contentTypeSelectNode,"change");Alfresco.logger.debug("END showMetadataDialog")},showMainDialog:function(){Alfresco.logger.debug("showMainDialog",arguments);this.records=null;this.currentRecordIndex=-1;YAHOO.util.Dom.removeClass(this.id+"-main-dialog","fake-hidden");YAHOO.util.Dom.addClass(this.id+"-metadata-dialog","hidden");this.centerPanel();Alfresco.logger.debug("END showMainDialog")},onMetadataSubmit:function(a){Alfresco.logger.debug("onMetadataSubmit",arguments);
this.formUi.formsRuntime._setAllFieldsAsVisited();this.formUi.formsRuntime.validate()?(Alfresco.logger.debug("Form validated"),this.processMetadata(),this.widgets.form._submitInvoked.call(this.widgets.form,a)):(Alfresco.logger.debug("Form with errors"),Alfresco.util.PopupManager.displayMessage({text:this.msg("validation.errors.correct.before.proceeding")}));Alfresco.logger.debug("END onMetadataSubmit")},processMetadata:function(){Alfresco.logger.debug("processMetadata",arguments);var a=YAHOO.util.Dom.get(this.id+
"-contentTypeInput");a&&(Alfresco.logger.debug("contentTypeInputNode found"),a.value=this.contentTypeSelectNode.value);a=this.formUi.formsRuntime;var c=Dom.get(a.formId);a=a._buildAjaxForSubmit(c);c=YAHOO.util.Dom.get(this.widgets.form.formId);for(var b in a)if(Alfresco.logger.debug("Current:",b),a.hasOwnProperty(b)&&("prop_mimetype"!=b||"prop_mimetype"==b&&YAHOO.lang.isString(a[b])&&0<a[b].length)){Alfresco.logger.debug("Adding property",b);var d=document.createElement("input");d.setAttribute("type",
"hidden");d.setAttribute("name",b);d.setAttribute("value",a[b]);c.appendChild(d)}Alfresco.logger.debug("END processMetadata",a)},onMetadataCancel:function(){Alfresco.logger.debug("onMetadataCancel",arguments);this.showMainDialog();Alfresco.logger.debug("END onMetadataCancel")},_applyConfig:function(a){SoftwareLoop.HtmlUpload.superclass._applyConfig.apply(this,arguments);var c=Dom.get(this.id+"-htmlupload-form");null===this.showConfig.uploadURL&&(c.action=Alfresco.constants.PROXY_URI+"uploader-plus/upload.html")}}))})();
